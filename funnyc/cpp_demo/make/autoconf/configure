#!/bin/bash


if test "x$1" != xCHECKME; then
  echo "ERROR: Calling this wrapper script directly is not supported."
  echo "Use the 'configure' script in the top-level directory instead."
  exit 1
fi


# The next argument is the absolute top-level directory path.
# The TOPDIR variable is passed on to configure.ac.
TOPDIR="$2"
# Remove these two arguments to get to the user supplied arguments
shift
shift


if test "x$BASH" = x; then
  echo "Error: This script must be run using bash." 1>&2
  exit 1
fi
# Force autoconf to use bash. This also means we must disable autoconf re-exec.
export CONFIG_SHELL=$BASH
export _as_can_reexec=no

# Make sure all shell commands are executed with the C locale
export LC_ALL=C


CURRENT_DIR=`pwd`
echo $CURRENT_DIR


build_support_dir="$TOPDIR/build/.configure-support"
conf_script_dir="$TOPDIR/make/autoconf"
generated_script="$build_support_dir/generated-configure.sh"


echo "Generating runnable configure script at $generated_script"
AUTOCONF="`which autoconf 2> /dev/null | grep -v '^no autoconf in'`"
autoconf_version=`$AUTOCONF --version | head -1`
echo "Using autoconf at ${AUTOCONF} [$autoconf_version]"
mkdir -p $build_support_dir
# Call autoconf but replace the "magic" variable in configure.ac if requested.
cat $conf_script_dir/configure.ac | ${AUTOCONF} -W all -I$conf_script_dir - > $generated_script
rm -rf autom4te.cache


# Make configure exit with error on invalid options as default.
# Can be overridden by --disable-option-checking, since we prepend our argument
# and later options override earlier.
conf_processed_arguments="--enable-option-checking=fatal"


###
### Call the configure script
###
# Turn on shell debug output if requested (initial or recursive)
#set -x


# Now transfer control to the script generated by autoconf. This is where the
# main work is done.
RCDIR=`mktemp -dt jdk-build-configure.tmp.duanjuntao.XXXXXXXXX` || exit $?
trap "rm -rf \"$RCDIR\"" EXIT


(exec 3>&1 ; ((. $generated_script "${conf_processed_arguments[@]}" 2>&1 1>&3 ); echo $? > "$RCDIR/rc" ))
conf_result_code=`cat "$RCDIR/rc"`
exit $conf_result_code
